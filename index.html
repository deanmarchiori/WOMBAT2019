<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Pearls and pitfalls of time series analysis</title>
    <meta charset="utf-8" />
    <meta name="author" content="WOMBAT 2019" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Pearls and pitfalls of time series analysis
## using Google Analytics data
### WOMBAT 2019

---





class: center  

# Dean Marchiori  
deanmarchiori.github.io  

&lt;img src="img/dean.jpg" width="276" /&gt;

---

Clinical pearls are " small bits of free standing, clinically relevant information. " (Lorin MI, 2008)

Lorin, Martin &amp; Palazzi, Debra &amp; Turner, Teri &amp; Ward, Mark. (2008). What is a clinical pearl and what is its role in medical education?. Medical teacher. 30. 870-4. 10.1080/01421590802144286. 

---

# Industrial data analysis  

* Productive  
* Efficient  
* Effective 

&gt; Profitable  


---
class: inverse, center, middle  

# Perfect is the enemy of good

---

# Everything you need to know  
# The least you need to know


---


# analyst being compentent  

# tools being well designed  

---

# What is Google Analytics?   

* web analytics service  
* free (to a point)  
* awesome for basic reports    

&lt;img src="img/ga.png" width="2449" /&gt;


---

# What is it not?   
* advanced analytics / modelling platform  
* extensible   
* simple  

&lt;img src="img/ga2.png" width="2457" /&gt;


---

# What is BigQuery   

* Google cloud based data warehouse solution  
* Get a full export daily of all sessions and hits  
* query in a SQL like syntax  
* (Users of Analytics 360 only)


&lt;img src="img/bq-1.png" width="295" /&gt;

&lt;img src="img/bq-2.png" width="907" /&gt;

---

# How GA thinks about data   

## Dimensions  

--

The attributes of your data  

--

## Metrics  

--

The quantitative measurements  

---

# example  

page | sessions 
--|---
/ | 526  
/aboutme | 251  
/contact | 230  

--

`page` : is the dimension  
`sessions`: is the metric  

---

# time series example    


|date       | sessions|
|:----------|--------:|
|2019-07-01 |        1|
|2019-07-02 |       17|
|2019-07-03 |        2|
|2019-07-04 |        4|
|2019-07-05 |        0|
|2019-07-06 |        0|
|2019-07-07 |        1|
|2019-07-08 |        1|
|2019-07-09 |        3|
|2019-07-10 |        2|
|2019-07-11 |        0|
|2019-07-12 |        3|


---

# Going nuts

|date       |browser           |browserversion   | sessions| bouncerate|
|:----------|:-----------------|:----------------|--------:|----------:|
|2019-07-01 |Chrome            |75.0.3770.100    |        1|    0.00000|
|2019-07-02 |'Mozilla          |5.0              |       16|  100.00000|
|2019-07-02 |Chrome            |72.0.3626.109    |        1|    0.00000|
|2019-07-03 |Chrome            |72.0.3626.109    |        1|    0.00000|
|2019-07-03 |Chrome            |75.0.3770.100    |        1|    0.00000|
|2019-07-04 |Chrome            |75.0.3770.100    |        3|   33.33333|
|2019-07-04 |Safari            |13.0             |        1|  100.00000|
|2019-07-07 |Opera             |52.4.2517.140781 |        1|  100.00000|
|2019-07-08 |Chrome            |75.0.3770.100    |        1|  100.00000|
|2019-07-09 |Chrome            |72.0.3626.109    |        1|    0.00000|
|2019-07-09 |Chrome            |73.0.3683.88     |        1|  100.00000|
|2019-07-09 |Chrome            |75.0.3770.100    |        1|  100.00000|
|2019-07-10 |Chrome            |75.0.3770.100    |        1|    0.00000|
|2019-07-10 |Firefox           |67.0             |        1|  100.00000|
|2019-07-12 |Chrome            |75.0.3770.100    |        1|  100.00000|
|2019-07-12 |Chrome            |75.0.3770.101    |        1|  100.00000|

---
class: inverse, center, middle

# Yeah, but how do I get it out?  

---

# API    

&lt;img src="img/api.png" width="1771" /&gt;

source: https://developers.google.com/analytics  

---

# API    

&lt;img src="img/api2.png" width="1788" /&gt;

source: https://developers.google.com/analytics  


---

# Use Standard SQL

There are two dialects:  

* Standard SQL  
* Legacy SQL


```sql
*#standardSQL
SELECT  date, 
        totals.visits, 
        totals.pageviews 

FROM `bigquery-public-data.google_analytics_sample.ga_sessions_20170801`
```


---

# Learn Arrays and STRUCTS    

Array: Ordered list of zero or more elements of any non-ARRAY type.   
STRUCT:  Container of ordered fields each with a type  



```sql
SELECT [1, 2, 3] AS numbers; 
```

---  

---
# Structured / Relational Database  


&lt;img src="img/rdb.png" width="2059" /&gt;


---
# Semi-Structured / Denormalised 

&lt;img src="img/ssdb.png" width="283" /&gt;

---

# Example  


```sql
#standardSQL
SELECT  'Gin and Tonic' AS drink,
        ['Gin', 'Tonic'] AS ingredients
  UNION ALL
SELECT  'Martini' AS drink,
        ['Gin', 'Dry Vermouth'] AS ingredients
  UNION ALL
SELECT  'Manhattan' AS drink,
        ['Rye Whiskey', 'Sweet Vermouth', 'Angostura bitters'] AS ingredients
```

![](img/eg1.png)&lt;!-- --&gt;

---

# Example  


```sql
SELECT drink FROM cocktails
```

![](img/eg2.png)&lt;!-- --&gt;

---

# Example  


```sql
SELECT  drink, 
        flat_ingredients
FROM cocktails
* CROSS JOIN UNNEST(cocktails.ingredients) as flat_ingredients
```

![](img/eg3.png)&lt;!-- --&gt;

---

# Learn about table suffix  


---
class: inverse, center, middle

# Yeah, but how do I get it out???  


---

# Use `googleAnalyticsR`    

Maintained by Mark Edmondson  

- Well maintained  
- Well documented  
- Loads of useful functions  

Notable Mentions:  
* rga  
* RGoogleAnalytics  
* ganalytics  
* GAR  



---

# Time series example    



```r
library(googleAnalyticsR)
library(tsibble)
library(fable)
library(tidyverse)

ga_demo &lt;- google_analytics(viewId = 184371396, 
                            date_range = c('2019-07-01', '2019-08-31'), 
                            dimensions = c("date"),
                            metrics = "sessions", 
                            max = -1) %&gt;% 
  as_tsibble()

ga_demo %&gt;%  
  model(ets = ETS(sessions)) %&gt;% 
  forecast(h = 20) %&gt;% 
  autoplot(ga_demo)
```

---

![](index_files/figure-html/unnamed-chunk-20-1.png)&lt;!-- --&gt;


---

# Rows returned   

* Defaults to 1000
* Up to 100k rows per API call  
* Batches of up to 5 can be processed, but complicated requests may result in a `500` error     

See `slow_fetch = TRUE`  


```r
library(googleAnalyticsR)

my_ga &lt;- google_analytics(viewId = 184371396, 
                          date_range = c('2019-01-01', '2019-02-01'), 
                          dimensions = "date",
                          metrics = "sessions", 
*                         max = -1)
```

`max`:	 Maximum number of rows to fetch. Defaults at 1000. Use -1 to fetch all results. Ignored when anti_sample=TRUE.    


---
 
# Sampling &amp; Limits    

* To speed up processing, Google with 'sample' reports based on just a percentage of total sessions if above a threshold (~500k)  
* You can control sampling with `samplingLevel = c("DEFAULT", "SMALL", "LARGE")`  
* Or turn it off - but this uses more API calls 


```r
library(googleAnalyticsR)

my_ga &lt;- google_analytics(viewId = 184371396, 
                          date_range = c('2019-01-01', '2019-02-01'), 
                          dimensions = "date",
                          metrics = "sessions", 
                          max = -1, 
*                         anti_sample = TRUE)
```

`anti_sample`: If TRUE will split up the call to avoid sampling.

---

# Time zones and DST    

* the timezone of your data is based on the settings for that particular view  

*"If you choose a time zone that honors Daylight Savings Time, Analytics automatically adjusts for the changes. If you do not want Analytics to adjust for Daylight Savings time, then you can use Greenwich Mean Time instead of your local time zone."*  

https://support.google.com/analytics/answer/1010249?hl=en

---

# Modelling Functions  


---
class: inverse, center, middle

# Don't-skip-resources  

---

# Sample Dataset  

https://support.google.com/analytics/answer/7586738?hl=en  


&lt;img src="img/sample.png" width="2057" /&gt;

---

# Big Query Cookbook  

https://support.google.com/analytics/answer/4419694?hl=en&amp;ref_topic=3416089


---

# Export Schema  

https://support.google.com/analytics/answer/3437719?hl=en&amp;ref_topic=3416089

---

# Query Explorer

https://ga-dev-tools.appspot.com/query-explorer/

&lt;img src="img/queryexplorer.png" width="392" /&gt;

---

# Dimensions and Metrics Explorer

https://ga-dev-tools.appspot.com/dimensions-metrics-explorer/

&lt;img src="img/dimmtricexpl.png" width="217" /&gt;
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
